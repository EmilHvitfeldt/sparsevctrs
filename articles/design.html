<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="sparsevctrs">
<title>Design behind sparsevctrs • sparsevctrs</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Design behind sparsevctrs">
<meta property="og:description" content="sparsevctrs">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">sparsevctrs</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/design.html">Design behind sparsevctrs</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/EmilHvitfeldt/sparsevctrs/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Design behind sparsevctrs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EmilHvitfeldt/sparsevctrs/blob/HEAD/vignettes/design.Rmd" class="external-link"><code>vignettes/design.Rmd</code></a></small>
      <div class="d-none name"><code>design.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EmilHvitfeldt/sparsevctrs" class="external-link">sparsevctrs</a></span><span class="op">)</span></span></code></pre></div>
<p>The sparsevctrs package produces 3 things; ALTREP classes,
matrix/data.frame converting functions, helper functions. This document
outlines the rationale behind each of these and the decisions behind
them.</p>
<div class="section level2">
<h2 id="altrep-functions">Altrep Functions<a class="anchor" aria-label="anchor" href="#altrep-functions"></a>
</h2>
<p>The functions <code><a href="../reference/sparse_double.html">sparse_double()</a></code> and its relatives are used
to construct sparse vectors of the noted type. To work they all need 4
pieces of information:</p>
<ul>
<li><code>values</code></li>
<li><code>positions</code></li>
<li><code>length</code></li>
<li>
<code>default</code> (defaults to 0)</li>
</ul>
<p>The values need to match the type of the function name or be easily
coerced into the type (double -&gt; integer). The positions should be
integers or doubles that can losslessly be turned into integers. The
length should be a single non-negative integer-like value.</p>
<p>Values and positions are paired, and will thus be expected to be the
same length, furthermore, positions are expected to be sorted in
increasing order with no duplicates. The ordering is done to let the
various extraction methods work as efficiently as possible.</p>
<p>These functions have quite strict input checking by choice, to allow
the inner workings to be as efficient as possible.</p>
<p>The input of these functions mirrors the values stored in the ALTREP
class that they produce.</p>
</div>
<div class="section level2">
<h2 id="converting-functions">Converting Functions<a class="anchor" aria-label="anchor" href="#converting-functions"></a>
</h2>
<p>3 functions fall into this category:</p>
<ul>
<li><code><a href="../reference/coerce_to_sparse_data_frame.html">coerce_to_sparse_data_frame()</a></code></li>
<li><code><a href="../reference/coerce_to_sparse_tibble.html">coerce_to_sparse_tibble()</a></code></li>
<li><code><a href="../reference/coerce_to_sparse_matrix.html">coerce_to_sparse_matrix()</a></code></li>
</ul>
<p>the first two take a sparse matrix from the Matrix package and
produce a data.frame/tibble with sparse columns. The last one takes a
data.frame/tibble with sparse columns and produces a sparse matrix using
the Matrix package.</p>
<p>These functions are expected to be inverse of each other, such that
<code>coerce_to_sparse_matrix(coerce_to_sparse_data_frame(x))</code>
returns <code>x</code> back. They are made to be highly performant both
in terms of speed and memory consumption, Meaning that sparsity is
applied when appropriate.</p>
<p>These functions have quite strict input checking by choice, to allow
the inner workings to be as efficient as possible. It is in part why
data.frames with sparse vectors with different can’t be used with
<code><a href="../reference/coerce_to_sparse_matrix.html">coerce_to_sparse_matrix()</a></code> yet.</p>
</div>
<div class="section level2">
<h2 id="helper-functions">Helper Functions<a class="anchor" aria-label="anchor" href="#helper-functions"></a>
</h2>
<p>There are 3 types of helper functions. First, we have the
<code>is_*</code> family of functions. The specific
<code><a href="../reference/type-predicates.html">is_sparse_double()</a></code> and more general
<code><a href="../reference/type-predicates.html">is_sparse_vector()</a></code> can be used as a way to determine
whether a vector is an ALTREP sparse vector. This is otherwise hard to
tell as <code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric()</a></code> can’t tell the difference.</p>
<p>Secondly, we have the extraction functions. They are
<code><a href="../reference/extractors.html">sparse_values()</a></code> and <code><a href="../reference/extractors.html">sparse_positions()</a></code>. These
extract the values and positions respectively, without materializing the
whole dense vector. These functions are made to work with non-sparse
vectors as well to make them more ergonomic for the user. Internally
they call <code><a href="../reference/type-predicates.html">is_sparse_vector()</a></code>, so the choice to return
something useful as the alternative wasn’t hard. There is no
<code>sparse_length()</code> function as <code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code> works
with these types of</p>
<p>The last type of helper function is less clearly defined and is
expanded as needed. The functions provide alternatives to functions that
don’t have ALTREP support. Such as <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>. Calling
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> on a sparse vector will force materialization, and
then calculate the mean. This is memory inefficient as it could have
been calculated like so.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/extractors.html">sparse_values</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p>These functions, all starting with the name prefix
<code>sparse_*</code>, are made to work with non-sparse vectors for the
same reasons listed above regarding ergonomic use.</p>
</div>
<div class="section level2">
<h2 id="faq">FAQ<a class="anchor" aria-label="anchor" href="#faq"></a>
</h2>
<blockquote>
<p>Why aren’t the results returned as {vctrs} classes?</p>
</blockquote>
<p>As it stands right now, it is viewed to be beneficial to have the
users not be alerted to these vectors as they are expected to be used
internally in packages and rarely by the end user. Furthermore having
these sparse vectors produce the same result as dense vectors with
<code><a href="https://rdrr.io/r/base/class.html" class="external-link">class()</a></code> is a big plus.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Emil Hvitfeldt.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
